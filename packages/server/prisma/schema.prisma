generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Host {
  hostId String @id @default(uuid())
  name   String @db.VarChar(255)
  type   String @db.VarChar(50) // 'ssh' | 'api'

  // SSH fields
  hostname           String? @db.VarChar(255)
  port               Int?    @default(22)
  username           String? @db.VarChar(255)
  password           String? @db.Text
  hostKeyFingerprint String? @db.VarChar(255)

  // API fields
  endpoint String? @db.VarChar(255)
  apiKey   String? @db.Text
  provider String? @db.VarChar(100)
  model    String? @db.VarChar(100)

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  workspaces Workspace[]
  clankers   Clanker[]
}

model Project {
  projectId   String      @id @default(uuid())
  name        String      @db.VarChar(255)
  description String?     @db.Text
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  workspaces  Workspace[]
}

model Workspace {
  workspaceId      String    @id @default(uuid())
  projectId        String
  project          Project   @relation(fields: [projectId], references: [projectId], onDelete: Cascade)
  name             String    @db.VarChar(255)
  hostId           String?
  host             Host?     @relation(fields: [hostId], references: [hostId], onDelete: SetNull)
  path             String?   @db.Text
  primaryClankerId String?
  primaryClanker   Clanker?  @relation("PrimaryClanker", fields: [primaryClankerId], references: [clankerId], onDelete: SetNull)
  currentClankerId String?
  currentClanker   Clanker?  @relation("CurrentClanker", fields: [currentClankerId], references: [clankerId], onDelete: SetNull)
  sessionId        String?   @db.VarChar(255)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  messages         Message[]
  clankers         WorkspaceClanker[]

  @@index([projectId])
  @@index([hostId])
  @@index([primaryClankerId])
  @@index([currentClankerId])
}

model WorkspaceClanker {
  workspaceClankerId  String    @id @default(uuid())
  workspaceId         String
  workspace           Workspace @relation(fields: [workspaceId], references: [workspaceId], onDelete: Cascade)
  clankerId           String
  clanker             Clanker   @relation(fields: [clankerId], references: [clankerId], onDelete: Cascade)
  modelOverride       String?   @db.VarChar(100)
  temperatureOverride Float?
  createdAt           DateTime  @default(now())

  @@unique([workspaceId, clankerId])
  @@index([workspaceId])
  @@index([clankerId])
}

model Message {
  messageId   String    @id @default(uuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [workspaceId], onDelete: Cascade)
  role        String    @db.VarChar(50)
  content     String    @db.Text
  toolCalls   Json?
  rawEvents   Json?
  status      String    @default("pending") @db.VarChar(50)
  createdAt   DateTime  @default(now())

  @@index([workspaceId])
}

model Clanker {
  clankerId String @id @default(uuid())
  name      String @db.VarChar(255)
  adapterId String @db.VarChar(100)

  // Console adapters only — which SSH host runs this CLI tool
  hostId String?
  host   Host?   @relation(fields: [hostId], references: [hostId], onDelete: SetNull)

  // Adapter-specific config — driven by adapter.fields
  config Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  primaryWorkspaces  Workspace[]        @relation("PrimaryClanker")
  currentWorkspaces  Workspace[]        @relation("CurrentClanker")
  workspaceClankers  WorkspaceClanker[]

  @@index([hostId])
  @@index([adapterId])
}

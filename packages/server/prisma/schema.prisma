generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Host {
  hostId String @id @default(uuid())
  name   String @db.VarChar(255)
  type   String @db.VarChar(50) // 'ssh' | 'api'

  // SSH fields
  hostname           String? @db.VarChar(255)
  port               Int?    @default(22)
  username           String? @db.VarChar(255)
  password           String? @db.Text
  hostKeyFingerprint String? @db.VarChar(255)

  // API fields
  endpoint String? @db.VarChar(255)
  apiKey   String? @db.Text
  provider String? @db.VarChar(100)
  model    String? @db.VarChar(100)

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  workspaces Workspace[]
  clankers   Clanker[]
}

model Project {
  projectId   String      @id @default(uuid())
  name        String      @db.VarChar(255)
  description String?     @db.Text
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  workspaces  Workspace[]
}

model Workspace {
  workspaceId String    @id @default(uuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [projectId], onDelete: Cascade)
  hostId      String
  host        Host      @relation(fields: [hostId], references: [hostId], onDelete: Cascade)
  name        String    @db.VarChar(255)
  path        String?   @db.Text
  sessionId   String?   @db.VarChar(255)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  messages    Message[]

  @@index([projectId])
  @@index([hostId])
}

model Message {
  messageId   String    @id @default(uuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [workspaceId], onDelete: Cascade)
  role        String    @db.VarChar(50)
  content     String    @db.Text
  toolCalls   Json?
  rawEvents   Json?
  status      String    @default("pending") @db.VarChar(50)
  createdAt   DateTime  @default(now())

  @@index([workspaceId])
}

model Clanker {
  clankerId String @id @default(uuid())
  name      String @db.VarChar(255)
  adapterId String @db.VarChar(100)

  // Console adapters only — which SSH host runs this CLI tool
  hostId String?
  host   Host?   @relation(fields: [hostId], references: [hostId], onDelete: SetNull)

  // Adapter-specific config — driven by adapter.fields
  config Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hostId])
  @@index([adapterId])
}
